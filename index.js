"use strict";
var IO = require("socket.io");
var express = require("express");
var bodyParser = require("body-parser");
var jwt = require("jsonwebtoken");
var pathExists = require("path-exists");
var cors = require("cors");
var docker = require("dockerlogs");
var merge = require("json-add");
var http = require("http");
var socketioJwt = require("socketio-jwt");
var app = express();
var ioSocket;
var options = {
    port: 6767,
    secret: new Date().getTime() + "xxx",
    password: 'admindocker'
};
if (pathExists.sync("./conf.json"))
    merge(options, require("./conf.json"));
app.all("/*", function (req, res, next) {
    res.header("Access-Control-Allow-Origin", "*");
    next();
});
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(cors());
if (pathExists.sync("/app") && pathExists.sync("/index.html"))
    app.use("/", express.static(__dirname + "/app"));
var server = http.createServer(app);
var io = IO(server);
console.log("listen :" + options.port);
io.use(socketioJwt.authorize({
    secret: options.secret,
    handshake: true
}));
io.on('connection', socketioJwt.authorize({
    secret: options.secret,
    timeout: 15000
})).on('authenticated', function (socket) {
    socket.join('user');
    console.log('new user');
    socket.on("subscribe", function (room) {
        console.log("joining room", room);
        socket.join(room);
    });
});
io.on("disconnection", function (socket) {
    console.log("bye! ");
});
var Docker = new docker();
var streamInspect = false;
Docker.stream(function (data) {
    if (data !== streamInspect) {
        streamInspect = data;
        io.sockets.in("inspects").emit("inspects", streamInspect);
    }
});
app.post("/signin", function (req, res) {
    if (req.body && req.body.pass && req.body.pass === options.password) {
        var token = jwt.sign({ ok: "oki" }, options.secret, { expiresIn: "2 days" });
        res.json({ token: token });
    }
    else {
        res.json({ error: 'wrong auth' });
    }
});
app.get("/about", function (req, res) {
    res.json(Docker);
});
app.get("/data", function (req, res) {
    if (streamInspect) {
        res.json(streamInspect);
    }
    else {
        Docker.data().then(function (data) {
            res.json(data);
        }).catch(function (err) {
            res.json(err);
        });
    }
});
server.listen(options.port);

//# sourceMappingURL=data:application/json;charset=utf8;base64,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S0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ0osR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7QUFFTCxDQUFDLENBQUMsQ0FBQTtBQUVGLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLFVBQVUsR0FBRyxFQUFFLEdBQUc7SUFDaEMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNyQixDQUFDLENBQUMsQ0FBQTtBQUdGLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFVBQVUsR0FBRyxFQUFFLEdBQUc7SUFFL0IsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUNoQixHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNKLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJO1lBQzdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRztZQUNsQixHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUFBO0lBRU4sQ0FBQztBQUtMLENBQUMsQ0FBQyxDQUFBO0FBQ0YsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBJTyBmcm9tIFwic29ja2V0LmlvXCI7XG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gXCJleHByZXNzXCI7XG5pbXBvcnQgKiBhcyBib2R5UGFyc2VyIGZyb20gXCJib2R5LXBhcnNlclwiO1xuaW1wb3J0ICogYXMgand0IGZyb20gXCJqc29ud2VidG9rZW5cIjtcbmltcG9ydCAqIGFzIHBhdGhFeGlzdHMgZnJvbSBcInBhdGgtZXhpc3RzXCI7XG5pbXBvcnQgKiBhcyBjb3JzIGZyb20gXCJjb3JzXCI7XG5pbXBvcnQgZG9ja2VyID0gcmVxdWlyZShcImRvY2tlcmxvZ3NcIik7XG5pbXBvcnQgbWVyZ2UgPSByZXF1aXJlKFwianNvbi1hZGRcIik7XG5pbXBvcnQgdGltZXJkYWVtb24gPSByZXF1aXJlKFwidGltZXJkYWVtb25cIik7XG5cbmltcG9ydCAqIGFzIGh0dHAgZnJvbSBcImh0dHBcIjtcblxuY29uc3Qgc29ja2V0aW9Kd3QgPSByZXF1aXJlKFwic29ja2V0aW8tand0XCIpO1xuXG5pbnRlcmZhY2UgSWRlZmF1bHRzIHtcbiAgICBwb3J0OiBudW1iZXI7XG4gICAgc2VjcmV0OiBzdHJpbmc7XG4gICAgcGFzc3dvcmQ6IHN0cmluZztcbn1cblxuXG5cbmNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcblxuXG5sZXQgaW9Tb2NrZXQ6IGFueTtcblxuXG5cbmxldCBvcHRpb25zOiBJZGVmYXVsdHMgPSB7XG4gICAgcG9ydDogNjc2NyxcbiAgICBzZWNyZXQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgXCJ4eHhcIixcbiAgICBwYXNzd29yZDogJ2FkbWluZG9ja2VyJ1xufVxuXG5cblxuXG5pZiAocGF0aEV4aXN0cy5zeW5jKFwiLi9jb25mLmpzb25cIikpIG1lcmdlKG9wdGlvbnMsIHJlcXVpcmUoXCIuL2NvbmYuanNvblwiKSlcblxuXG5cblxuXG5cblxuYXBwLmFsbChcIi8qXCIsIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xuICAgIHJlcy5oZWFkZXIoXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW5cIiwgXCIqXCIpO1xuXG4gICAgbmV4dCgpO1xufSk7XG5cbi8vIHBhcnNlIGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZFxuYXBwLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoeyBleHRlbmRlZDogZmFsc2UgfSkpO1xuXG4vLyBwYXJzZSBhcHBsaWNhdGlvbi9qc29uXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKTtcblxuYXBwLnVzZShjb3JzKCkpO1xuXG5pZiAocGF0aEV4aXN0cy5zeW5jKFwiL2FwcFwiKSAmJiBwYXRoRXhpc3RzLnN5bmMoXCIvaW5kZXguaHRtbFwiKSkgYXBwLnVzZShcIi9cIiwgZXhwcmVzcy5zdGF0aWMoX19kaXJuYW1lICsgXCIvYXBwXCIpKTtcblxuXG5jb25zdCBzZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xuY29uc3QgaW8gPSBJTyhzZXJ2ZXIpO1xuXG5jb25zb2xlLmxvZyhcImxpc3RlbiA6XCIgKyBvcHRpb25zLnBvcnQpO1xuXG5cblxuaW8udXNlKHNvY2tldGlvSnd0LmF1dGhvcml6ZSh7XG4gICAgc2VjcmV0OiBvcHRpb25zLnNlY3JldCxcbiAgICBoYW5kc2hha2U6IHRydWVcblxufSkpO1xuXG5pby5vbignY29ubmVjdGlvbicsIHNvY2tldGlvSnd0LmF1dGhvcml6ZSh7XG4gICAgc2VjcmV0OiBvcHRpb25zLnNlY3JldCxcbiAgICB0aW1lb3V0OiAxNTAwMCAvLyAxNSBzZWNvbmRzIHRvIHNlbmQgdGhlIGF1dGhlbnRpY2F0aW9uIG1lc3NhZ2Vcbn0pKS5vbignYXV0aGVudGljYXRlZCcsIGZ1bmN0aW9uIChzb2NrZXQpIHtcbiAgICBzb2NrZXQuam9pbigndXNlcicpO1xuICAgIGNvbnNvbGUubG9nKCduZXcgdXNlcicpXG4gICAgc29ja2V0Lm9uKFwic3Vic2NyaWJlXCIsIGZ1bmN0aW9uIChyb29tKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiam9pbmluZyByb29tXCIsIHJvb20pO1xuICAgICAgICBzb2NrZXQuam9pbihyb29tKTtcbiAgICB9KTtcbn0pO1xuXG5pby5vbihcImRpc2Nvbm5lY3Rpb25cIiwgZnVuY3Rpb24gKHNvY2tldCkge1xuICAgIC8vIGluIHNvY2tldC5pbyAxLjBcblxuXG4gICAgY29uc29sZS5sb2coXCJieWUhIFwiKTtcbn0pO1xuXG5sZXQgRG9ja2VyID0gbmV3IGRvY2tlcigpO1xuXG5sZXQgc3RyZWFtSW5zcGVjdDogYW55ID0gZmFsc2U7XG5cbkRvY2tlci5zdHJlYW0oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICBpZiAoZGF0YSAhPT0gc3RyZWFtSW5zcGVjdCkge1xuICAgICAgICBzdHJlYW1JbnNwZWN0ID0gZGF0YTtcbiAgICAgICAgaW8uc29ja2V0cy5pbihcImluc3BlY3RzXCIpLmVtaXQoXCJpbnNwZWN0c1wiLCBzdHJlYW1JbnNwZWN0KTtcbiAgICB9XG5cbn0pXG5hcHAucG9zdChcIi9zaWduaW5cIiwgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG5cblxuICAgIGlmIChyZXEuYm9keSYmcmVxLmJvZHkucGFzcyAmJiByZXEuYm9keS5wYXNzID09PSBvcHRpb25zLnBhc3N3b3JkKSB7XG4gICAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oeyBvazogXCJva2lcIiB9LCBvcHRpb25zLnNlY3JldCwgeyBleHBpcmVzSW46IFwiMiBkYXlzXCIgfSk7XG4gICAgICAgIHJlcy5qc29uKHsgdG9rZW46IHRva2VuIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5qc29uKHsgZXJyb3I6ICd3cm9uZyBhdXRoJyB9KTtcbiAgICB9XG5cbn0pXG5cbmFwcC5nZXQoXCIvYWJvdXRcIiwgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oRG9ja2VyKTtcbn0pXG5cblxuYXBwLmdldChcIi9kYXRhXCIsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuXG4gICAgaWYgKHN0cmVhbUluc3BlY3QpIHtcbiAgICAgICAgcmVzLmpzb24oc3RyZWFtSW5zcGVjdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgRG9ja2VyLmRhdGEoKS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICByZXMuanNvbihkYXRhKTtcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgcmVzLmpzb24oZXJyKTtcbiAgICAgICAgfSlcblxuICAgIH1cblxuXG5cblxufSlcbnNlcnZlci5saXN0ZW4ob3B0aW9ucy5wb3J0KTsiXX0=
