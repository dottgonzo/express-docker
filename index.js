"use strict";
var IO = require("socket.io");
var express = require("express");
var bodyParser = require("body-parser");
var jwt = require("jsonwebtoken");
var pathExists = require("path-exists");
var cors = require("cors");
var docker = require("dockerlogs");
var merge = require("json-add");
var http = require("http");
var socketioJwt = require("socketio-jwt");
var app = express();
var ioSocket;
var options = {
    port: 6767,
    secret: new Date().getTime() + "xxx",
    password: 'admindocker'
};
if (pathExists.sync("./conf.json"))
    merge(options, require("./conf.json"));
app.all("/*", function (req, res, next) {
    res.header("Access-Control-Allow-Origin", "*");
    next();
});
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(cors());
if (pathExists.sync("/app") && pathExists.sync("/index.html"))
    app.use("/", express.static(__dirname + "/app"));
var server = http.createServer(app);
var io = IO(server);
console.log("listen :" + options.port);
io.use(socketioJwt.authorize({
    secret: options.secret,
    handshake: true
}));
io.on('connection', socketioJwt.authorize({
    secret: options.secret,
    timeout: 15000
})).on('authenticated', function (socket) {
    socket.join('user');
    socket.on("subscribe", function (room) {
        console.log("joining room", room);
        socket.join(room);
    });
});
io.on("disconnection", function (socket) {
    console.log("bye! ");
});
var Docker = new docker();
var streamInspect = false;
Docker.stream(function (data) {
    if (data !== streamInspect) {
        streamInspect = data;
        io.sockets.in("inspects").emit("inspects", streamInspect);
    }
});
app.post("/signin", function (req, res) {
    if (req.body && req.body.pass && req.body.pass === options.password) {
        var token = jwt.sign({ ok: "oki" }, options.secret, { expiresIn: "2 days" });
        res.json({ token: token });
    }
    else {
        res.json({ error: 'wrong auth' });
    }
});
app.get("/about", function (req, res) {
    res.json(Docker);
});
app.get("/data", function (req, res) {
    if (streamInspect) {
        res.json(streamInspect);
    }
    else {
        Docker.data().then(function (data) {
            res.json(data);
        }).catch(function (err) {
            res.json(err);
        });
    }
});
server.listen(options.port);

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNKLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztJQUN0QyxDQUFDO0FBRUwsQ0FBQyxDQUFDLENBQUE7QUFFRixHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxVQUFVLEdBQUcsRUFBRSxHQUFHO0lBQ2hDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDckIsQ0FBQyxDQUFDLENBQUE7QUFHRixHQUFHLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxVQUFVLEdBQUcsRUFBRSxHQUFHO0lBRS9CLEVBQUUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFDaEIsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDSixNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSTtZQUM3QixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUc7WUFDbEIsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FBQTtJQUVOLENBQUM7QUFLTCxDQUFDLENBQUMsQ0FBQTtBQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgSU8gZnJvbSBcInNvY2tldC5pb1wiO1xuaW1wb3J0ICogYXMgZXhwcmVzcyBmcm9tIFwiZXhwcmVzc1wiO1xuaW1wb3J0ICogYXMgYm9keVBhcnNlciBmcm9tIFwiYm9keS1wYXJzZXJcIjtcbmltcG9ydCAqIGFzIGp3dCBmcm9tIFwianNvbndlYnRva2VuXCI7XG5pbXBvcnQgKiBhcyBwYXRoRXhpc3RzIGZyb20gXCJwYXRoLWV4aXN0c1wiO1xuaW1wb3J0ICogYXMgY29ycyBmcm9tIFwiY29yc1wiO1xuaW1wb3J0IGRvY2tlciA9IHJlcXVpcmUoXCJkb2NrZXJsb2dzXCIpO1xuaW1wb3J0IG1lcmdlID0gcmVxdWlyZShcImpzb24tYWRkXCIpO1xuaW1wb3J0IHRpbWVyZGFlbW9uID0gcmVxdWlyZShcInRpbWVyZGFlbW9uXCIpO1xuXG5pbXBvcnQgKiBhcyBodHRwIGZyb20gXCJodHRwXCI7XG5cbmNvbnN0IHNvY2tldGlvSnd0ID0gcmVxdWlyZShcInNvY2tldGlvLWp3dFwiKTtcblxuaW50ZXJmYWNlIElkZWZhdWx0cyB7XG4gICAgcG9ydDogbnVtYmVyO1xuICAgIHNlY3JldDogc3RyaW5nO1xuICAgIHBhc3N3b3JkOiBzdHJpbmc7XG59XG5cblxuXG5jb25zdCBhcHAgPSBleHByZXNzKCk7XG5cblxubGV0IGlvU29ja2V0OiBhbnk7XG5cblxuXG5sZXQgb3B0aW9uczogSWRlZmF1bHRzID0ge1xuICAgIHBvcnQ6IDY3NjcsXG4gICAgc2VjcmV0OiBuZXcgRGF0ZSgpLmdldFRpbWUoKSArIFwieHh4XCIsXG4gICAgcGFzc3dvcmQ6ICdhZG1pbmRvY2tlcidcbn1cblxuXG5cblxuaWYgKHBhdGhFeGlzdHMuc3luYyhcIi4vY29uZi5qc29uXCIpKSBtZXJnZShvcHRpb25zLCByZXF1aXJlKFwiLi9jb25mLmpzb25cIikpXG5cblxuXG5cblxuXG5cbmFwcC5hbGwoXCIvKlwiLCBmdW5jdGlvbiAocmVxLCByZXMsIG5leHQpIHtcbiAgICByZXMuaGVhZGVyKFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luXCIsIFwiKlwiKTtcblxuICAgIG5leHQoKTtcbn0pO1xuXG4vLyBwYXJzZSBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRcbmFwcC51c2UoYm9keVBhcnNlci51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IGZhbHNlIH0pKTtcblxuLy8gcGFyc2UgYXBwbGljYXRpb24vanNvblxuYXBwLnVzZShib2R5UGFyc2VyLmpzb24oKSk7XG5cbmFwcC51c2UoY29ycygpKTtcblxuaWYgKHBhdGhFeGlzdHMuc3luYyhcIi9hcHBcIikgJiYgcGF0aEV4aXN0cy5zeW5jKFwiL2luZGV4Lmh0bWxcIikpIGFwcC51c2UoXCIvXCIsIGV4cHJlc3Muc3RhdGljKF9fZGlybmFtZSArIFwiL2FwcFwiKSk7XG5cblxuY29uc3Qgc2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKTtcbmNvbnN0IGlvID0gSU8oc2VydmVyKTtcblxuY29uc29sZS5sb2coXCJsaXN0ZW4gOlwiICsgb3B0aW9ucy5wb3J0KTtcblxuXG5cbmlvLnVzZShzb2NrZXRpb0p3dC5hdXRob3JpemUoe1xuICAgIHNlY3JldDogb3B0aW9ucy5zZWNyZXQsXG4gICAgaGFuZHNoYWtlOiB0cnVlXG5cbn0pKTtcblxuaW8ub24oJ2Nvbm5lY3Rpb24nLCBzb2NrZXRpb0p3dC5hdXRob3JpemUoe1xuICAgIHNlY3JldDogb3B0aW9ucy5zZWNyZXQsXG4gICAgdGltZW91dDogMTUwMDAgLy8gMTUgc2Vjb25kcyB0byBzZW5kIHRoZSBhdXRoZW50aWNhdGlvbiBtZXNzYWdlXG59KSkub24oJ2F1dGhlbnRpY2F0ZWQnLCBmdW5jdGlvbiAoc29ja2V0KSB7XG4gICAgc29ja2V0LmpvaW4oJ3VzZXInKTtcbiAgICBzb2NrZXQub24oXCJzdWJzY3JpYmVcIiwgZnVuY3Rpb24gKHJvb20pIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJqb2luaW5nIHJvb21cIiwgcm9vbSk7XG4gICAgICAgIHNvY2tldC5qb2luKHJvb20pO1xuICAgIH0pO1xufSk7XG5cbmlvLm9uKFwiZGlzY29ubmVjdGlvblwiLCBmdW5jdGlvbiAoc29ja2V0KSB7XG4gICAgLy8gaW4gc29ja2V0LmlvIDEuMFxuXG5cbiAgICBjb25zb2xlLmxvZyhcImJ5ZSEgXCIpO1xufSk7XG5cbmxldCBEb2NrZXIgPSBuZXcgZG9ja2VyKCk7XG5cbmxldCBzdHJlYW1JbnNwZWN0OiBhbnkgPSBmYWxzZTtcblxuRG9ja2VyLnN0cmVhbShmdW5jdGlvbiAoZGF0YSkge1xuICAgIGlmIChkYXRhICE9PSBzdHJlYW1JbnNwZWN0KSB7XG4gICAgICAgIHN0cmVhbUluc3BlY3QgPSBkYXRhO1xuICAgICAgICBpby5zb2NrZXRzLmluKFwiaW5zcGVjdHNcIikuZW1pdChcImluc3BlY3RzXCIsIHN0cmVhbUluc3BlY3QpO1xuICAgIH1cblxufSlcbmFwcC5wb3N0KFwiL3NpZ25pblwiLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcblxuXG4gICAgaWYgKHJlcS5ib2R5JiZyZXEuYm9keS5wYXNzICYmIHJlcS5ib2R5LnBhc3MgPT09IG9wdGlvbnMucGFzc3dvcmQpIHtcbiAgICAgICAgY29uc3QgdG9rZW4gPSBqd3Quc2lnbih7IG9rOiBcIm9raVwiIH0sIG9wdGlvbnMuc2VjcmV0LCB7IGV4cGlyZXNJbjogXCIyIGRheXNcIiB9KTtcbiAgICAgICAgcmVzLmpzb24oeyB0b2tlbjogdG9rZW4gfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLmpzb24oeyBlcnJvcjogJ3dyb25nIGF1dGgnIH0pO1xuICAgIH1cblxufSlcblxuYXBwLmdldChcIi9hYm91dFwiLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICByZXMuanNvbihEb2NrZXIpO1xufSlcblxuXG5hcHAuZ2V0KFwiL2RhdGFcIiwgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG5cbiAgICBpZiAoc3RyZWFtSW5zcGVjdCkge1xuICAgICAgICByZXMuanNvbihzdHJlYW1JbnNwZWN0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBEb2NrZXIuZGF0YSgpLnRoZW4oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgIHJlcy5qc29uKGRhdGEpO1xuICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICByZXMuanNvbihlcnIpO1xuICAgICAgICB9KVxuXG4gICAgfVxuXG5cblxuXG59KVxuc2VydmVyLmxpc3RlbihvcHRpb25zLnBvcnQpOyJdfQ==
