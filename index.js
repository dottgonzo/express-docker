"use strict";
var IO = require("socket.io");
var express = require("express");
var bodyParser = require("body-parser");
var jwt = require("jsonwebtoken");
var pathExists = require("path-exists");
var cors = require("cors");
var docker = require("dockerlogs");
var merge = require("json-add");
var http = require("http");
var socketioJwt = require("socketio-jwt");
var app = express();
var ioSocket;
var options = {
    port: 6767,
    secret: new Date().getTime() + "xxx",
    password: 'admindocker'
};
if (pathExists.sync("./conf.json"))
    merge(options, require("./conf.json"));
app.all("/*", function (req, res, next) {
    res.header("Access-Control-Allow-Origin", "*");
    next();
});
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(cors());
if (pathExists.sync("/app") && pathExists.sync("/index.html"))
    app.use("/", express.static(__dirname + "/app"));
var server = http.createServer(app);
var io = IO(server);
console.log("listen :" + options.port);
io.use(socketioJwt.authorize({
    secret: options.secret,
    handshake: true
}));
io.on("connection", function (socket) {
    console.log("connected");
    socket.on("subscribe", function (room) {
        console.log("joining room", room);
        socket.join(room);
    });
    console.log("hello! ");
});
io.on("disconnection", function (socket) {
    console.log("bye! ");
});
var Docker = new docker();
var streamInspect = false;
Docker.stream(function (data) {
    if (data !== streamInspect) {
        streamInspect = data;
        io.sockets.in("inspects").emit("inspects", streamInspect);
    }
});
app.post("/login/:password", function (req, res) {
    var password = req.params.password;
    if (password === options.password) {
        var token = jwt.sign({ ok: "oki" }, options.secret, { expiresIn: "2 days" });
        res.json({ token: token });
    }
    else {
        res.json({ error: 'wrong auth' });
    }
});
app.get("/about", function (req, res) {
    res.json(Docker);
});
app.get("/data", function (req, res) {
    if (streamInspect) {
        res.json(streamInspect);
    }
    else {
        Docker.data().then(function (data) {
            res.json(data);
        }).catch(function (err) {
            res.json(err);
        });
    }
});
server.listen(options.port);

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QztBQUVMLENBQUMsQ0FBQyxDQUFBO0FBRUYsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsVUFBVSxHQUFHLEVBQUUsR0FBRztJQUNoQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3JCLENBQUMsQ0FBQyxDQUFBO0FBR0YsR0FBRyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsVUFBVSxHQUFHLEVBQUUsR0FBRztJQUUvQixFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBQ2hCLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ0osTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUk7WUFDN0IsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNuQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHO1lBQ2xCLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQUE7SUFFTixDQUFDO0FBS0wsQ0FBQyxDQUFDLENBQUE7QUFDRixNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIElPIGZyb20gXCJzb2NrZXQuaW9cIjtcbmltcG9ydCAqIGFzIGV4cHJlc3MgZnJvbSBcImV4cHJlc3NcIjtcbmltcG9ydCAqIGFzIGJvZHlQYXJzZXIgZnJvbSBcImJvZHktcGFyc2VyXCI7XG5pbXBvcnQgKiBhcyBqd3QgZnJvbSBcImpzb253ZWJ0b2tlblwiO1xuaW1wb3J0ICogYXMgcGF0aEV4aXN0cyBmcm9tIFwicGF0aC1leGlzdHNcIjtcbmltcG9ydCAqIGFzIGNvcnMgZnJvbSBcImNvcnNcIjtcbmltcG9ydCBkb2NrZXIgPSByZXF1aXJlKFwiZG9ja2VybG9nc1wiKTtcbmltcG9ydCBtZXJnZSA9IHJlcXVpcmUoXCJqc29uLWFkZFwiKTtcbmltcG9ydCB0aW1lcmRhZW1vbiA9IHJlcXVpcmUoXCJ0aW1lcmRhZW1vblwiKTtcblxuaW1wb3J0ICogYXMgaHR0cCBmcm9tIFwiaHR0cFwiO1xuXG5jb25zdCBzb2NrZXRpb0p3dCA9IHJlcXVpcmUoXCJzb2NrZXRpby1qd3RcIik7XG5cbmludGVyZmFjZSBJZGVmYXVsdHMge1xuICAgIHBvcnQ6IG51bWJlcjtcbiAgICBzZWNyZXQ6IHN0cmluZztcbiAgICBwYXNzd29yZDogc3RyaW5nO1xufVxuXG5cblxuY29uc3QgYXBwID0gZXhwcmVzcygpO1xuXG5cbmxldCBpb1NvY2tldDogYW55O1xuXG5cblxubGV0IG9wdGlvbnM6IElkZWZhdWx0cyA9IHtcbiAgICBwb3J0OiA2NzY3LFxuICAgIHNlY3JldDogbmV3IERhdGUoKS5nZXRUaW1lKCkgKyBcInh4eFwiLFxuICAgIHBhc3N3b3JkOiAnYWRtaW5kb2NrZXInXG59XG5cblxuXG5cbmlmIChwYXRoRXhpc3RzLnN5bmMoXCIuL2NvbmYuanNvblwiKSkgbWVyZ2Uob3B0aW9ucywgcmVxdWlyZShcIi4vY29uZi5qc29uXCIpKVxuXG5cblxuXG5cblxuXG5hcHAuYWxsKFwiLypcIiwgZnVuY3Rpb24gKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgcmVzLmhlYWRlcihcIkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpblwiLCBcIipcIik7XG5cbiAgICBuZXh0KCk7XG59KTtcblxuLy8gcGFyc2UgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkXG5hcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7IGV4dGVuZGVkOiBmYWxzZSB9KSk7XG5cbi8vIHBhcnNlIGFwcGxpY2F0aW9uL2pzb25cbmFwcC51c2UoYm9keVBhcnNlci5qc29uKCkpO1xuXG5hcHAudXNlKGNvcnMoKSk7XG5cbmlmIChwYXRoRXhpc3RzLnN5bmMoXCIvYXBwXCIpICYmIHBhdGhFeGlzdHMuc3luYyhcIi9pbmRleC5odG1sXCIpKSBhcHAudXNlKFwiL1wiLCBleHByZXNzLnN0YXRpYyhfX2Rpcm5hbWUgKyBcIi9hcHBcIikpO1xuXG5cbmNvbnN0IHNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGFwcCk7XG5jb25zdCBpbyA9IElPKHNlcnZlcik7XG5cbmNvbnNvbGUubG9nKFwibGlzdGVuIDpcIiArIG9wdGlvbnMucG9ydCk7XG5cblxuXG5pby51c2Uoc29ja2V0aW9Kd3QuYXV0aG9yaXplKHtcbiAgICBzZWNyZXQ6IG9wdGlvbnMuc2VjcmV0LFxuICAgIGhhbmRzaGFrZTogdHJ1ZVxuXG59KSk7XG5cbmlvLm9uKFwiY29ubmVjdGlvblwiLCBmdW5jdGlvbiAoc29ja2V0KSB7XG4gICAgLy8gaW4gc29ja2V0LmlvIDEuMFxuXG4gICAgY29uc29sZS5sb2coXCJjb25uZWN0ZWRcIilcbiAgICBzb2NrZXQub24oXCJzdWJzY3JpYmVcIiwgZnVuY3Rpb24gKHJvb20pIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJqb2luaW5nIHJvb21cIiwgcm9vbSk7XG4gICAgICAgIHNvY2tldC5qb2luKHJvb20pO1xuICAgIH0pO1xuXG4gICAgY29uc29sZS5sb2coXCJoZWxsbyEgXCIpO1xufSk7XG5cbmlvLm9uKFwiZGlzY29ubmVjdGlvblwiLCBmdW5jdGlvbiAoc29ja2V0KSB7XG4gICAgLy8gaW4gc29ja2V0LmlvIDEuMFxuXG5cbiAgICBjb25zb2xlLmxvZyhcImJ5ZSEgXCIpO1xufSk7XG5cbmxldCBEb2NrZXIgPSBuZXcgZG9ja2VyKCk7XG5cbmxldCBzdHJlYW1JbnNwZWN0OiBhbnkgPSBmYWxzZTtcblxuRG9ja2VyLnN0cmVhbShmdW5jdGlvbiAoZGF0YSkge1xuICAgIGlmIChkYXRhICE9PSBzdHJlYW1JbnNwZWN0KSB7XG4gICAgICAgIHN0cmVhbUluc3BlY3QgPSBkYXRhO1xuICAgICAgICBpby5zb2NrZXRzLmluKFwiaW5zcGVjdHNcIikuZW1pdChcImluc3BlY3RzXCIsIHN0cmVhbUluc3BlY3QpO1xuICAgIH1cblxufSlcbmFwcC5wb3N0KFwiL2xvZ2luLzpwYXNzd29yZFwiLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcblxuICAgIGNvbnN0IHBhc3N3b3JkID0gcmVxLnBhcmFtcy5wYXNzd29yZFxuXG4gICAgaWYgKHBhc3N3b3JkID09PSBvcHRpb25zLnBhc3N3b3JkKSB7XG4gICAgICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oeyBvazogXCJva2lcIiB9LCBvcHRpb25zLnNlY3JldCwgeyBleHBpcmVzSW46IFwiMiBkYXlzXCIgfSk7XG4gICAgICAgIHJlcy5qc29uKHsgdG9rZW46IHRva2VuIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5qc29uKHsgZXJyb3I6ICd3cm9uZyBhdXRoJyB9KTtcbiAgICB9XG5cbn0pXG5cbmFwcC5nZXQoXCIvYWJvdXRcIiwgZnVuY3Rpb24gKHJlcSwgcmVzKSB7XG4gICAgcmVzLmpzb24oRG9ja2VyKTtcbn0pXG5cblxuYXBwLmdldChcIi9kYXRhXCIsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuXG4gICAgaWYgKHN0cmVhbUluc3BlY3QpIHtcbiAgICAgICAgcmVzLmpzb24oc3RyZWFtSW5zcGVjdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgRG9ja2VyLmRhdGEoKS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICByZXMuanNvbihkYXRhKTtcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgcmVzLmpzb24oZXJyKTtcbiAgICAgICAgfSlcblxuICAgIH1cblxuXG5cblxufSlcbnNlcnZlci5saXN0ZW4ob3B0aW9ucy5wb3J0KTsiXX0=
